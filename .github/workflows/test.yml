name: Qbs-Tests

on: push

jobs:
  windows:
    name: "test on windows"
    runs-on: windows-latest
    strategy:
      matrix:
        qt-version: [5.15.2, 6.2.0]
    steps:
      - name: Start PostgreSQL
        run: |
          $pgService = Get-Service -Name postgresql*
          Set-Service -InputObject $pgService -Status running -StartupType automatic
          Start-Process -FilePath "$env:PGBIN\pg_isready" -Wait -PassThru
          & $env:PGBIN\psql --command="CREATE USER test PASSWORD 'test';"
          & $env:PGBIN\psql --command="ALTER ROLE test WITH SUPERUSER LOGIN CREATEDB CREATEROLE;"
          & $env:PGBIN\psql --command="\du"

      - name: Start MySQL
        uses: fettpet/setup-mysql@v1
        with:
          mysql-version: 8.0
          install-directory: "${{ runner.workspace }}\\MySQL"

      - name: install mvsc
        uses: ilammy/msvc-dev-cmd@v1
        with:
          toolset: "14.29"

      - name: Install Qt
        uses: jurplel/install-qt-action@v2
        with:
          version: ${{matrix.qt-version}}
      
      - name: Install Plugin Qt
        uses: fettpet/qt_sql_plugin_installer@master
        with:
          mysql-install: true
          mysql-path: "${{ runner.workspace }}\\MySQL"
          postgresql-install: true
          postgresql-path: "${{ env.PGROOT }}"
          qt-version:  ${{matrix.qt-version}}

      - name: checkout
        uses: actions/checkout@v2

      - name: install qbs
        run: |
          choco install qbs
          qbs setup-toolchains --detect
          qbs config --list profiles

      - name: prepare config
        run: |
          move tests\mysql\MysqlConfig.h.github tests\mysql\MysqlConfig.h
          move tests\postgresql\PostgresqlConfig.h.github tests\postgresql\PostgresqlConfig.h
        shell: cmd

      - name: build and run tests
        run: |
          set QT_FORCE_STDERR_LOGGING=1
          set PATH=%PATH%;C:\Program Files\MySQL\MySQL Server 8.0\lib
          qbs build profile:MSVC2019-x64 --build-directory %RUNNER_TEMP%\build -p autotest-runner
        shell: cmd

  ubuntu:
    name: "test on ubuntu"
    runs-on: ubuntu-latest
    strategy:
      matrix:
        qt-version: [5.15.2, 6.2.0]
    services:
      postgres:
        image: postgres
        ports: ['5432:5432']
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        env:
          POSTGRES_PASSWORD: test
          POSTGRES_USER: test

    steps:
      
      - name: Start MySQL
        uses: fettpet/setup-mysql@v1
        with:
          mysql-version: 8.0
          install-directory: "${{ runner.workspace }}\\MySQL"

      - name: Install Qt
        uses: jurplel/install-qt-action@v2
        with:
          version: ${{matrix.qt-version}}

      - name: install qbs, clang12
        run: |
          sudo apt-get update -y
          sudo apt-get install -y clang-12 llvm-12 qbs

      - name: Install Plugin Qt
        uses: Fettpet/qt_sql_plugin_installer@master
        with:
          mysql-install: true
          postgresql-install: true
          qt-version: ${{matrix.qt-version}}

      - name: checkout
        uses: actions/checkout@v2

      - name: setup qbs
        run: |
          qbs setup-toolchains --detect
          qbs config --list profiles

      - name: prepare config
        run: |
          mv tests/mysql/MysqlConfig.h.github tests/mysql/MysqlConfig.h
          mv tests/postgresql/PostgresqlConfig.h.github tests/postgresql/PostgresqlConfig.h

      - name: build and run tests
        run: >-
         qbs build profile:clang
         --build-directory ${env:RUNNER_TEMP}\build
         -p autotest-runner
        env:
          POSTGRES_HOST: postgres
